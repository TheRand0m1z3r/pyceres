name: Create Manylinux Wheels
on:
  push:
    tags:
      - v*

jobs:
  manylinux-wheels:
    runs-on: ubuntu-latest
    name: Create the manylinux wheels for all supported Python versions
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          architecture: x64
      - name: Build docker image
        run: docker build -f Dockerfile.manylinux . -t dplus-ceres-manylinux:latest
      - name: Copy wheels
        run: |
          docker run --rm --name dplus-ceres-manylinux -v `pwd`:/external dplus-ceres-manylinux:latest
      - name: Upload to Release
        id: upload-release-asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dplus-ceres-wheels/dplus*.whl
          file_glob: true
          tag: ${{ github.ref }}
          overwrite: true
          body: "Manylinux Wheels"
      - name: Upload release to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1           
        with:
            id-token: write
            file: dplus-ceres-wheels/dplus*.whl
